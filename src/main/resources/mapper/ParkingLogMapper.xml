<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.aipms.mapper.ParkingLogMapper">

    <!-- INSERT: 차량 로그 저장 -->
    <insert id="insertLog" parameterType="com.aipms.domain.ParkingLog">
        INSERT INTO parking_log (car_number, member_id, parking_type, entry_time, exit_time, camera_id)
        VALUES (#{carNumber}, #{memberId}, #{parkingType}, #{entryTime}, #{exitTime}, #{cameraId})
    </insert>

    <!-- SELECT: 차량 로그 + 신청자 이름 포함 -->
    <select id="selectAllWithMember" resultType="com.aipms.dto.ParkingLogWithMemberDto">
        SELECT
            p.id,
            p.car_number,
            p.parking_type,
            p.entry_time,
            p.exit_time,
            p.camera_id,
            p.created_at,
            m.name AS member_name
        FROM parking_log p
                 LEFT JOIN member m ON p.member_id = m.member_id
        ORDER BY p.entry_time DESC
    </select>

    <select id="findLatestUnexitedLog" resultType="com.aipms.domain.ParkingLog" parameterType="string">
        SELECT *
        FROM parking_log
        WHERE car_number = #{carNumber}
          AND exit_time IS NULL
        ORDER BY entry_time DESC
            LIMIT 1
    </select>

    <update id="updateExitTime" parameterType="com.aipms.domain.ParkingLog">
        UPDATE parking_log
        SET exit_time = #{exitTime}
        WHERE id = #{id}
    </update>

</mapper>
